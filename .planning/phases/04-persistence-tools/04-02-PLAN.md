---
phase: 04-persistence-tools
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/db/queries.go
  - internal/tools/remember.go
  - internal/tools/forget.go
  - internal/tools/registry.go
  - internal/tools/remember_test.go
  - internal/tools/forget_test.go
autonomous: true

must_haves:
  truths:
    - "User can create relations between entities"
    - "User can delete entities by ID"
    - "Duplicate relations update metadata instead of creating duplicates"
    - "Deleting entity cascades to remove its relations"
  artifacts:
    - path: "internal/db/queries.go"
      provides: "QueryCreateRelation, QueryDeleteEntity functions"
      contains: "func.*QueryCreateRelation"
    - path: "internal/tools/forget.go"
      provides: "forget tool handler"
      exports: ["NewForgetHandler", "ForgetInput"]
    - path: "internal/tools/registry.go"
      provides: "forget tool registration"
      contains: "forget"
  key_links:
    - from: "internal/tools/remember.go"
      to: "internal/db/queries.go"
      via: "QueryCreateRelation call"
      pattern: "deps\\.DB\\.QueryCreateRelation"
    - from: "internal/tools/forget.go"
      to: "internal/db/queries.go"
      via: "QueryDeleteEntity call"
      pattern: "deps\\.DB\\.QueryDeleteEntity"
---

<objective>
Complete the remember tool with relation support and implement the forget tool for entity deletion.

Purpose: Enable full CRUD cycle - users can now create entities with relationships and remove them when obsolete.
Output: Working relations in remember tool + forget tool for entity deletion.
</objective>

<execution_context>
@/Users/raphaelgruber/.claude/get-shit-done/workflows/execute-plan.md
@/Users/raphaelgruber/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-persistence-tools/04-CONTEXT.md
@.planning/phases/04-persistence-tools/04-RESEARCH.md
@.planning/phases/04-persistence-tools/04-01-SUMMARY.md

# Existing code
@internal/db/queries.go
@internal/tools/remember.go
@internal/tools/registry.go
@internal/models/relation.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QueryCreateRelation and QueryDeleteEntity functions</name>
  <files>internal/db/queries.go</files>
  <action>
Add two query functions to db/queries.go:

**QueryCreateRelation:**
```go
// QueryCreateRelation creates or updates a relation between two entities.
// Uses RELATE which respects the unique_key index for deduplication.
// Returns error if source or target entity doesn't exist.
func (c *Client) QueryCreateRelation(
    ctx context.Context,
    fromID string,  // entity ID (without "entity:" prefix)
    relType string,
    toID string,
    weight float64,
) error
```

SQL pattern:
```sql
-- First verify both entities exist
LET $from_exists = (SELECT count() FROM entity WHERE id = type::record("entity", $from_id)).count() > 0;
LET $to_exists = (SELECT count() FROM entity WHERE id = type::record("entity", $to_id)).count() > 0;

IF !$from_exists OR !$to_exists {
    THROW "Entity not found"
};

RELATE type::record("entity", $from_id)->relates->type::record("entity", $to_id) SET
    rel_type = $rel_type,
    weight = $weight;
```

Important: The schema has a unique_key on relates table that handles deduplication.
If relation exists, this updates it (SurrealDB RELATE is upsert-like).

**QueryDeleteEntity:**
```go
// QueryDeleteEntity deletes an entity by ID.
// TYPE RELATION in schema auto-cascades relation deletion.
// Supports batch delete with multiple IDs.
// Returns count of deleted entities (0 if none found - idempotent).
func (c *Client) QueryDeleteEntity(ctx context.Context, ids ...string) (int, error)
```

SQL pattern:
```sql
-- Single delete
DELETE type::record("entity", $id) RETURN BEFORE;

-- Batch delete (pass array of record IDs)
DELETE entity WHERE id IN $ids RETURN BEFORE;
```

Return count of actually deleted entities (len of RETURN BEFORE results).
  </action>
  <verify>`go build ./...` compiles without errors</verify>
  <done>QueryCreateRelation and QueryDeleteEntity functions exist in queries.go</done>
</task>

<task type="auto">
  <name>Task 2: Add relation support to remember + implement forget handler</name>
  <files>internal/tools/remember.go, internal/tools/forget.go, internal/tools/registry.go</files>
  <action>
**Update remember.go to process relations:**

After processing entities, if Relations is non-empty:
1. Validate each relation: from, to, type required
2. Resolve entity names to IDs (using same slugify + context logic)
3. Call QueryCreateRelation for each
4. Collect results (success count, errors)

```go
// In NewRememberHandler, after entity loop:
relationsCreated := 0
relationErrors := []string{}

for _, rel := range input.Relations {
    if rel.From == "" || rel.To == "" || rel.Type == "" {
        relationErrors = append(relationErrors, "relation missing from/to/type")
        continue
    }

    fromID := generateEntityID(rel.From, contextStr)
    toID := generateEntityID(rel.To, contextStr)
    weight := rel.Weight
    if weight <= 0 {
        weight = 1.0  // default weight
    }

    if err := deps.DB.QueryCreateRelation(ctx, fromID, rel.Type, toID, weight); err != nil {
        relationErrors = append(relationErrors, fmt.Sprintf("%s->%s: %v", rel.From, rel.To, err))
        continue
    }
    relationsCreated++
}
```

Update response to include relations:
```json
{
  "entities": [...],
  "created": 2,
  "updated": 1,
  "relations_created": 3,
  "relation_errors": ["..."]  // only if any
}
```

**Create forget.go:**

```go
// ForgetInput defines the input schema for the forget tool.
type ForgetInput struct {
    IDs     []string `json:"ids" jsonschema:"required,Entity IDs to delete"`
    Context string   `json:"context,omitempty" jsonschema:"Project namespace for name resolution"`
}

// NewForgetHandler creates the forget tool handler.
// Deletes entities by ID. Idempotent - non-existent IDs silently succeed.
func NewForgetHandler(deps *Dependencies, cfg *config.Config) mcp.ToolHandlerFor[ForgetInput, any]
```

Handler logic:
1. Validate: at least one ID required
2. For each ID:
   - If looks like a name (no ":" and no "entity:" prefix), resolve via context
   - Otherwise use as-is (strip "entity:" prefix if present)
3. Call QueryDeleteEntity with all resolved IDs
4. Return count deleted

Response format:
```json
{
  "deleted": 3,
  "message": "Deleted 3 entities"
}
```

**Register in registry.go:**
```go
mcp.AddTool(server, &mcp.Tool{
    Name:        "forget",
    Description: "Delete entities from the knowledge graph by ID",
}, NewForgetHandler(deps, cfg))
```
  </action>
  <verify>`go build ./...` compiles; both remember and forget appear in tools/list</verify>
  <done>Relations processed in remember tool; forget tool deletes entities with cascade</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for relations and forget</name>
  <files>internal/tools/remember_test.go, internal/tools/forget_test.go</files>
  <action>
**Add to remember_test.go:**

1. **TestRememberHandler_RelationValidation** - relation missing from/to/type returns error
2. **TestRememberHandler_RelationCreated** - mock DB, verify QueryCreateRelation called
3. **TestRememberHandler_RelationWithMissingEntity** - error propagates correctly

**Create forget_test.go:**

1. **TestForgetHandler_Validation** - empty IDs returns error
2. **TestForgetHandler_SingleDelete** - mock DB, verify QueryDeleteEntity called
3. **TestForgetHandler_BatchDelete** - multiple IDs processed
4. **TestForgetHandler_NonExistent** - returns success with 0 deleted (idempotent)
5. **TestForgetInput_Schema** - verify JSON schema generation works

For integration tests (build tag: integration):
6. **TestRememberForget_Integration** - create entity, verify exists, delete, verify gone
7. **TestRelation_Integration** - create two entities, relate them, verify relation exists
  </action>
  <verify>`go test ./internal/tools/... -v` passes all unit tests</verify>
  <done>Relations and forget have unit test coverage</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go build ./...` - compiles without errors
2. `go test ./internal/tools/... -v` - all tests pass
3. `go test ./internal/db/... -v` - all tests pass
4. Tool registration: remember and forget both appear in tools/list
5. Manual test: create entity, create relation, delete entity via MCP
</verification>

<success_criteria>
- QueryCreateRelation function validates entity existence before creating
- QueryDeleteEntity returns count deleted (idempotent for non-existent)
- remember tool processes Relations array after entities
- forget tool deletes entities by ID with context-aware resolution
- Both tools registered in registry.go
- Unit tests pass for validation, happy path, and edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence-tools/04-02-SUMMARY.md`
</output>
