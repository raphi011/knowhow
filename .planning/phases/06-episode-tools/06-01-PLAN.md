---
phase: 06-episode-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/db/queries.go
  - internal/tools/episode.go
  - internal/tools/registry.go
autonomous: true

must_haves:
  truths:
    - "User can store episodes with content and auto-generated timestamp"
    - "User can retrieve episode by ID with full content"
    - "User can delete episode by ID"
    - "Entity linking works during episode creation"
  artifacts:
    - path: "internal/db/queries.go"
      provides: "Episode query functions"
      contains: "QueryCreateEpisode"
    - path: "internal/tools/episode.go"
      provides: "Episode tool handlers"
      exports: ["NewAddEpisodeHandler", "NewGetEpisodeHandler", "NewDeleteEpisodeHandler"]
    - path: "internal/tools/registry.go"
      provides: "Tool registration"
      contains: "add_episode"
  key_links:
    - from: "internal/tools/episode.go"
      to: "internal/db/queries.go"
      via: "deps.DB.QueryCreateEpisode"
      pattern: "deps\\.DB\\.QueryCreateEpisode"
    - from: "internal/tools/registry.go"
      to: "internal/tools/episode.go"
      via: "NewAddEpisodeHandler registration"
      pattern: "NewAddEpisodeHandler"
---

<objective>
Implement episode CRUD tools: add_episode, get_episode, delete_episode.

Purpose: Enable agents to store episodic memories (time-stamped experiences/conversations) and retrieve/delete them by ID.
Output: Three working MCP tools for episode management.
</objective>

<execution_context>
@/Users/raphaelgruber/.claude/get-shit-done/workflows/execute-plan.md
@/Users/raphaelgruber/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-episode-tools/06-CONTEXT.md
@.planning/phases/06-episode-tools/06-RESEARCH.md
@internal/models/episode.go
@internal/db/queries.go
@internal/tools/search.go
@internal/tools/registry.go
@internal/tools/helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add episode query functions to db/queries.go</name>
  <files>internal/db/queries.go</files>
  <action>
Add the following query functions to db/queries.go:

1. **QueryCreateEpisode** - Create episode with UPSERT:
   - Params: ctx, episodeID, content, embedding, timestamp, summary *string, metadata map[string]any, context *string
   - Use `UPSERT type::record("episode", $id)` pattern
   - Set created=time::now() on insert, preserve on update
   - Set accessed=time::now(), access_count defaults
   - Return *models.Episode, error

2. **QueryGetEpisode** - Retrieve episode by ID:
   - Params: ctx, id string
   - Use `SELECT * FROM type::record("episode", $id)`
   - Return *models.Episode, error (nil if not found)

3. **QueryUpdateEpisodeAccess** - Update access tracking:
   - Params: ctx, id string
   - Update accessed=time::now(), access_count+=1
   - Return error (fire-and-forget pattern)

4. **QueryDeleteEpisode** - Delete episode by ID:
   - Params: ctx, id string
   - Use `DELETE type::record("episode", $id) RETURN BEFORE`
   - Return count int, error (0 if not found, idempotent)

5. **QueryLinkEntityToEpisode** - Create extracted_from relation:
   - Params: ctx, entityID, episodeID string, position int, confidence float64
   - Use `RELATE type::record("entity", $entity_id)->extracted_from->type::record("episode", $episode_id)`
   - Set position and confidence on relation
   - Return error (failures logged, don't break episode creation)

Follow existing patterns in queries.go:
- Use surrealdb.Query[T] generic pattern
- Handle nil/empty results consistently
- Wrap errors with fmt.Errorf
  </action>
  <verify>
Run: `go build ./...` - compiles without errors
Check: New functions exist with correct signatures
  </verify>
  <done>
5 query functions added: QueryCreateEpisode, QueryGetEpisode, QueryUpdateEpisodeAccess, QueryDeleteEpisode, QueryLinkEntityToEpisode
  </done>
</task>

<task type="auto">
  <name>Task 2: Create episode.go with CRUD tool handlers</name>
  <files>internal/tools/episode.go</files>
  <action>
Create internal/tools/episode.go with three tool handlers:

**Input types:**

```go
type AddEpisodeInput struct {
    Content   string         `json:"content" jsonschema:"required,Full episode content (conversation, notes, etc.)"`
    Summary   string         `json:"summary,omitempty" jsonschema:"Optional brief summary"`
    Metadata  map[string]any `json:"metadata,omitempty" jsonschema:"Flexible metadata (session_id, source, participants)"`
    Context   string         `json:"context,omitempty" jsonschema:"Project namespace (auto-detected if omitted)"`
    EntityIDs []string       `json:"entity_ids,omitempty" jsonschema:"Entity IDs to link as extracted from this episode"`
}

type GetEpisodeInput struct {
    ID              string `json:"id" jsonschema:"required,Episode ID (with or without 'episode:' prefix)"`
    IncludeEntities bool   `json:"include_entities,omitempty" jsonschema:"Include linked entities in response"`
}

type DeleteEpisodeInput struct {
    ID string `json:"id" jsonschema:"required,Episode ID to delete"`
}
```

**Handlers:**

1. **NewAddEpisodeHandler(deps, cfg):**
   - Validate content not empty
   - Generate timestamp-based ID: `ep_` + RFC3339 with colons replaced by hyphens
   - Detect context using DetectContext(cfg)
   - Truncate content to 8000 chars for embedding
   - Generate embedding via deps.Embedder.Embed()
   - Call QueryCreateEpisode
   - Link entities (log failures, don't fail operation, return linked count)
   - Return JSON with truncated content (500 chars), timestamp, linkedEntities count

2. **NewGetEpisodeHandler(deps):**
   - Extract bare ID (strip "episode:" prefix)
   - Call QueryGetEpisode
   - Return ErrorResult if not found
   - Call QueryUpdateEpisodeAccess
   - If IncludeEntities: query linked entities via extracted_from relation (add helper query if needed)
   - Return full content in response

3. **NewDeleteEpisodeHandler(deps):**
   - Extract bare ID
   - Call QueryDeleteEpisode
   - Return count of deleted (0 if not found, idempotent)

**Helper functions:**
- `extractEpisodeID(id string) string` - strips "episode:" prefix
- `generateEpisodeID() string` - creates timestamp-based ID
- `truncateContent(s string, max int) string` - truncates with ellipsis

Follow existing patterns from search.go:
- Use ErrorResult for validation/not-found errors
- Use TextResult for JSON output
- Log operations via deps.Logger
  </action>
  <verify>
Run: `go build ./...` - compiles without errors
Check: episode.go exports NewAddEpisodeHandler, NewGetEpisodeHandler, NewDeleteEpisodeHandler
  </verify>
  <done>
episode.go created with 3 handlers and helper functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Register episode tools in registry.go</name>
  <files>internal/tools/registry.go</files>
  <action>
Update RegisterAll() in registry.go to register the three episode tools:

```go
// Add episode tool - store episodic memories
mcp.AddTool(server, &mcp.Tool{
    Name:        "add_episode",
    Description: "Store a conversation or experience as an episodic memory with auto-generated timestamp and embedding",
}, NewAddEpisodeHandler(deps, cfg))

// Get episode tool - retrieve by ID
mcp.AddTool(server, &mcp.Tool{
    Name:        "get_episode",
    Description: "Retrieve an episodic memory by its ID with full content",
}, NewGetEpisodeHandler(deps))

// Delete episode tool - remove by ID
mcp.AddTool(server, &mcp.Tool{
    Name:        "delete_episode",
    Description: "Delete an episodic memory by its ID",
}, NewDeleteEpisodeHandler(deps))
```

Place after existing tools (traverse, find_path).
  </action>
  <verify>
Run: `go build ./...` - compiles without errors
Run: `go run ./cmd/memcp-go tools` or check via MCP inspector - should list 12 tools total
  </verify>
  <done>
3 episode tools registered: add_episode, get_episode, delete_episode
Total tools: 12 (ping, search, get_entity, list_labels, list_types, remember, forget, traverse, find_path, add_episode, get_episode, delete_episode)
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go test ./...` passes (existing tests)
3. Manual verification: Start server, use MCP inspector to:
   - Call add_episode with content "Test conversation" - returns episode ID
   - Call get_episode with returned ID - shows full content
   - Call delete_episode with ID - returns deleted count 1
   - Call get_episode again - returns not found
</verification>

<success_criteria>
- [ ] QueryCreateEpisode, QueryGetEpisode, QueryUpdateEpisodeAccess, QueryDeleteEpisode, QueryLinkEntityToEpisode in db/queries.go
- [ ] episode.go with 3 handlers + helper functions
- [ ] 3 tools registered in registry.go
- [ ] `go build ./...` passes
- [ ] add_episode stores episode with embedding
- [ ] get_episode retrieves by ID
- [ ] delete_episode removes episode
</success_criteria>

<output>
After completion, create `.planning/phases/06-episode-tools/06-01-SUMMARY.md`
</output>
